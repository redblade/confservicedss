# ConfService and DSS Pledger integration scenarios


Note: actions listed with [A] are done automatically

### ConfService component

>Pledger components integrated: Orchestrator, Benchmarking, SLA Lite


user roles:
- **administrators**: manages users and roles to access ConfService and DSS
- **infrastructure providers**: configure their infrastructures to make them available to the Service Providers
- **service providers**: configure their Apps, the related SLA and Guarantees with metrics and thresholds

#### administrators
##### user configuration
- create and manage users and their roles (API access, Service Provider, Infrastructure Provider)

##### log management
- check the system and audit logs

#### infrastructure providers
##### configuration
- configure their Infrastructure and Nodes 
- [A] ConfService automatically extracts and adds "hardware label" to the Nodes automatically, if the Infrastructure supports it
- label the Nodes with "domain labels" (eg. location, **security capabilities**)
- configure whether he/she wants to benchmark an infrastructure
- [A] ConfService automatically sends a msg on StreamHandler using Kafka to alert the other Pledger core components:
    - Benchmarking Suite: gets the Infrastructure and Nodes from the ConfService
    - SLA Lite: gets the Infrastructure and Nodes from the ConfService
    - Orchestrator:  gets the Infrastructure and Nodes from the ConfService

##### basic monitoring
- read the Benchmarks
- read the reports about Infrastructure, Node and Benchmark

#### service providers

##### configuration of App/SLA/Guarantee

- configure **Projects** to define the quota available on a specific Infrastructure
- configure **CatalogApps** with descriptors to be possibly used during the App creation stage
- configure **Apps** either manually writing a descriptor or re-using existing one from a CatalogApp
- configure **Apps**' **reserved resources** and initial parameters
- [A] ConfService creates Service starting from the App descriptor (App can be made of multiple Services)
- configure **SLA** per Service, specifying the type: 
    - **active**: used by the DSS for Service resource management - a SLA violation of this type is expected to be generated by application metrics which depends on resource (cpu/mem)
    - **suspend**: used by the DSS to suspend Service resource management on the Service - a SLA violation of this type is expected to be generated when a major issue occurs and no resource increase would improve the Service behavior
    - **ignore**: not used by the DSS - a SLA violation of this type is ignored by the DSS, it could be used by other components (eg. smart contract)
- configure **Guarantees** for each SLA, with the **metric** to monitor and the different **thresholds** 
- [A] ConfService automatically sends a msg on StreamHandler using Kafka to alert the other Pledger core components:
     - SLA Lite: gets the Project, App, Service, SLA, Guarantee from the ConfService
- read the **ServiceReports**
- configures the **App profile** with labels


##### configuration of DSS options

- configure the DSS **ServiceConstraints** for each Service to define the deployment priorities based on the Node "hardware" and "domain" labels
- [A] the DSS create **DeploymentOptions** with different options where a Service can be deployed, with **ranking**
- configure the DSS **ServiceOptimisation** policy for each Service:
    - **resource**: the DSS dynamically changes the Service reserved resorces. More details in the DSS component.
    - **latency**: the DSS optimises the edge-to-cloud latency according to ECODA algorithm
    - **resource_latency**: the DSS dynamically changes the Service resource reserved AND also optimises the edge-to-cloud latency according to ECODA algorithm 
    - **webhook**: the DSS invokes an external URL when a violation is received to allow custom automations


## DSS component

>Pledger components integrated: Orchestrator, ConfService, Benchmarking, MonitoringEngine, AppProfiler, SLA Lite
   
##### App start/stop

- Service provider starts/stops an App
- [A] the DSS sends messages on Kafka about App start/stop for the **Orchestrator**

##### monitoring activities
- [A] the DSS synchronizes with the **ConfService** and uses the same configuration
- [A] the DSS receives messages on Kafka, by the **Benchmarking**, and stores Benchmarks and BenchmarkReports
- [A] the DSS receives messages on Kafka, by the **MonitoringEngine**, about system metrics and application resource metrics for Infrastructures which do not support Prometheus and stores them in NodeReport and ServiceReport
- [A] the DSS extracts system metrics and application resource metrics from Kubernetes through metrics-server and GoldPinger and store them in NodeReport and ServiceReport
- [A] the DSS receives messages on Kafka, by the **AppProfiler**, about the best Benchmark for a given Service and stores its name in the Service profile 
- [A] the DSS receives messages on Kafka, by the **SLA Lite**, with SLA Violations and categorizes them


##### optimisation activities
- [A] the DSS, for SLA of type **active** and for which the Service has not received violations on SLA of type **suspend** for some time, decides whether to **increase reserved resources** or not depending on the **actual Service resource usage** being close to the Service reserved resources configured
- [A] the DSS, for Services that have not received SLA violations for some time, decides whether to **reduce reserved resources** or not
- [A] the DSS optimises Services based on their ServiceOptimisation configured:
    - **resource**: it changes the Service reserved resources values like follows: 
       - if the decision is to **increase reserved resources** and the current DeploymentOptions has enough resources, depending on the **severity score** it triggers a scaling up/out, otherwise it triggers an offloading to a worse ranking (edge to cloud). Both actions send messages on Kafka for the **Orchestrator**
       - if the decision is to **decrease reserved resources** and there is a better DeploymentOptions with enough resources, depending on the **severity score** it triggers an offload (cloud to edge), otherwise it triggers a scaling down/in. Both actions send messages on Kafka for the **Orchestrator**
    - **latency**: periodically checks the ECODA monitoring metrics. Depending on the new deployment plan updates and on the **severity score**, the DSS triggers the offloading sending messages on Kafka for the **Orchestrator**
    - **resource_latency**: works as with **resource** and also checking the ECODA monitoring metrics. Eventually the DSS triggers the scaling/offloading sending messages on Kafka for the **Orchestrator**
    - **webhook**: invokes an external URL to allow custom automation
- [A] the DSS, when offloading, decides the Nodes where to run the Service. If more than one are available with the same **severity score**, it uses Benchmarks (with the best "performance_index" metric) to choose the Node
- [A] the DSS, to choose which Benchmark to use for a given Service, in case no Benchmark name is configured for a Service (by the AppProfiler), matches the App labels with the Benchmark ones




